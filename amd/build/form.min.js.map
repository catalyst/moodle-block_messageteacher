{"version":3,"file":"form.min.js","sources":["../src/form.js"],"sourcesContent":["\ndefine(['core/fragment', 'core/ajax', 'core/modal_factory', 'core/modal_events', 'core/str'],\n        function(Fragment, Ajax, ModalFactory, ModalEvents, Str) {\n\n    var t = {\n        modal: null,\n\n        responseModal: null,\n\n        contextid: null,\n\n        appendurl: false,\n\n        /**\n         * Create modals.\n         *\n         * Create a Save/Cancel modal to display the form, and a Cancel modal for confirmation/error messages.\n         */\n        init: async function() {\n\n            const title = await Str.get_string('pluginname', 'block_messageteacher');\n            const send = await Str.get_string('send', 'block_messageteacher');\n\n            t.responseModal = await ModalFactory.create({\n                type: ModalFactory.types.DEFAULT,\n                title: title\n            });\n\n            t.modal = await ModalFactory.create({\n                type: ModalFactory.types.SAVE_CANCEL,\n                title: title\n            });\n            t.modal.setLarge();\n            t.modal.setSaveButtonText(send);\n\n            t.modal.getRoot().on(ModalEvents.hidden, function() {\n                t.modal.setBody('');\n            }.bind(this));\n\n            // We catch the modal save event, and use it to submit the form inside the modal.\n            // Triggering a form submission will give JS validation scripts a chance to check for errors.\n            t.modal.getRoot().on(ModalEvents.save, function(e) {\n                e.preventDefault();\n                t.modal.getRoot().find('form').submit();\n            });\n            // We also catch the form submit event and use it to submit the form with ajax.\n            t.modal.getRoot().on('submit', 'form', t.submitForm);\n\n            var links = document.querySelectorAll('.messageteacher_link');\n            for (var i = 0; i < links.length; i++) {\n                if (t.contextid === null) {\n                    t.contextid = links[i].parentElement.parentElement.dataset.contextid;\n                    t.appendurl = links[i].parentElement.parentElement.dataset.appendurl;\n                }\n                links[i].addEventListener('click', t.showForm);\n            }\n        },\n\n        /**\n         * Get the page fragment for the form.\n         *\n         * @param {array} params\n         * @returns {*|Deferred}\n         */\n        getForm: function(params) {\n            return Fragment.loadFragment('block_messageteacher', 'message_form', t.contextid, params);\n        },\n\n        /**\n         * Display the form modal and load the form.\n         *\n         * @param {Event} e\n         */\n        showForm: function(e) {\n            e.preventDefault();\n            t.modal.show();\n            t.modal.setBody(t.getForm(e.currentTarget.dataset));\n        },\n\n        /**\n         * Send the message entered into the form using a core webservice.\n         *\n         * @param {Event} e\n         */\n        submitForm: async function(e) {\n            e.preventDefault();\n            var recipientid = t.modal.getRoot().find('[name=recipientid]').val();\n            var message = t.modal.getRoot().find('[name=message]').val();\n            if (t.appendurl) {\n                message += \"\\n\\n\" + t.modal.getRoot().find('[name=referurl]').val();\n            }\n\n            M.util.js_pending('block_messageteacher_send');\n\n            try {\n                const response = await Ajax.call([{\n                    methodname: 'core_message_send_instant_messages',\n                    args: {\n                        'messages': [\n                            {\n                                'touserid': recipientid,\n                                'text': message\n                            }\n                        ]\n                    }\n                }])[0];\n\n                t.modal.hide();\n                if (response.msgid === -1) {\n                    t.responseModal.setBody(response.errormessage);\n                } else {\n                    const sent = await Str.get_string('messagesent', 'block_messageteacher');\n                    t.responseModal.setBody(sent);\n                }\n                t.responseModal.show();\n                M.util.js_complete('block_messageteacher_send');\n            } catch (ex) {\n                t.modal.hide();\n                t.responseModal.setBody(ex.message);\n                t.responseModal.show();\n                M.util.js_complete('block_messageteacher_send');\n            }\n        }\n    };\n\n    return t;\n});"],"names":["define","Fragment","Ajax","ModalFactory","ModalEvents","Str","t","modal","responseModal","contextid","appendurl","init","async","title","get_string","send","create","type","types","DEFAULT","SAVE_CANCEL","setLarge","setSaveButtonText","getRoot","on","hidden","setBody","bind","this","save","e","preventDefault","find","submit","submitForm","links","document","querySelectorAll","i","length","parentElement","dataset","addEventListener","showForm","getForm","params","loadFragment","show","currentTarget","recipientid","val","message","M","util","js_pending","response","call","methodname","args","hide","msgid","errormessage","sent","js_complete","ex"],"mappings":"AACAA,mCAAO,CAAC,gBAAiB,YAAa,qBAAsB,oBAAqB,aACzE,SAASC,SAAUC,KAAMC,aAAcC,YAAaC,SAEpDC,EAAI,CACJC,MAAO,KAEPC,cAAe,KAEfC,UAAW,KAEXC,WAAW,EAOXC,KAAMC,uBAEIC,YAAcR,IAAIS,WAAW,aAAc,wBAC3CC,WAAaV,IAAIS,WAAW,OAAQ,wBAE1CR,EAAEE,oBAAsBL,aAAaa,OAAO,CACxCC,KAAMd,aAAae,MAAMC,QACzBN,MAAOA,QAGXP,EAAEC,YAAcJ,aAAaa,OAAO,CAChCC,KAAMd,aAAae,MAAME,YACzBP,MAAOA,QAEXP,EAAEC,MAAMc,WACRf,EAAEC,MAAMe,kBAAkBP,MAE1BT,EAAEC,MAAMgB,UAAUC,GAAGpB,YAAYqB,OAAQ,WACrCnB,EAAEC,MAAMmB,QAAQ,KAClBC,KAAKC,OAIPtB,EAAEC,MAAMgB,UAAUC,GAAGpB,YAAYyB,MAAM,SAASC,GAC5CA,EAAEC,iBACFzB,EAAEC,MAAMgB,UAAUS,KAAK,QAAQC,YAGnC3B,EAAEC,MAAMgB,UAAUC,GAAG,SAAU,OAAQlB,EAAE4B,oBAErCC,MAAQC,SAASC,iBAAiB,wBAC7BC,EAAI,EAAGA,EAAIH,MAAMI,OAAQD,IACV,OAAhBhC,EAAEG,YACFH,EAAEG,UAAY0B,MAAMG,GAAGE,cAAcA,cAAcC,QAAQhC,UAC3DH,EAAEI,UAAYyB,MAAMG,GAAGE,cAAcA,cAAcC,QAAQ/B,WAE/DyB,MAAMG,GAAGI,iBAAiB,QAASpC,EAAEqC,WAU7CC,QAAS,SAASC,eACP5C,SAAS6C,aAAa,uBAAwB,eAAgBxC,EAAEG,UAAWoC,SAQtFF,SAAU,SAASb,GACfA,EAAEC,iBACFzB,EAAEC,MAAMwC,OACRzC,EAAEC,MAAMmB,QAAQpB,EAAEsC,QAAQd,EAAEkB,cAAcP,WAQ9CP,WAAYtB,eAAekB,GACvBA,EAAEC,qBACEkB,YAAc3C,EAAEC,MAAMgB,UAAUS,KAAK,sBAAsBkB,MAC3DC,QAAU7C,EAAEC,MAAMgB,UAAUS,KAAK,kBAAkBkB,MACnD5C,EAAEI,YACFyC,SAAW,OAAS7C,EAAEC,MAAMgB,UAAUS,KAAK,mBAAmBkB,OAGlEE,EAAEC,KAAKC,WAAW,uCAGRC,eAAiBrD,KAAKsD,KAAK,CAAC,CAC9BC,WAAY,qCACZC,KAAM,UACU,CACR,UACgBT,iBACJE,cAIpB,MAEJ7C,EAAEC,MAAMoD,QACgB,IAApBJ,SAASK,MACTtD,EAAEE,cAAckB,QAAQ6B,SAASM,kBAC9B,OACGC,WAAazD,IAAIS,WAAW,cAAe,wBACjDR,EAAEE,cAAckB,QAAQoC,MAE5BxD,EAAEE,cAAcuC,OAChBK,EAAEC,KAAKU,YAAY,6BACrB,MAAOC,IACL1D,EAAEC,MAAMoD,OACRrD,EAAEE,cAAckB,QAAQsC,GAAGb,SAC3B7C,EAAEE,cAAcuC,OAChBK,EAAEC,KAAKU,YAAY,uCAKxBzD"}
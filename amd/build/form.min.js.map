{"version":3,"file":"form.min.js","sources":["../src/form.js"],"sourcesContent":["\ndefine(['core/fragment', 'core/ajax', 'core/modal_factory', 'core/modal_events', 'core/str'],\n        function(Fragment, Ajax, ModalFactory, ModalEvents, Str) {\n\n    var t = {\n        modal: null,\n\n        responseModal: null,\n\n        contextid: null,\n\n        appendurl: false,\n\n        /**\n         * Create modals.\n         *\n         * Create a Save/Cancel modal to display the form, and a Cancel modal for confirmation/error messages.\n         */\n        init: async function() {\n\n            const title = await Str.get_string('pluginname', 'block_messageteacher');\n            const send = await Str.get_string('send', 'block_messageteacher');\n\n            ModalFactory.create({\n                type: ModalFactory.types.DEFAULT,\n                title: title\n            }).then(function(modal) {\n                t.responseModal = modal;\n            });\n\n            ModalFactory.create({\n                type: ModalFactory.types.SAVE_CANCEL,\n                title: title\n            }).then(function(modal) {\n                t.modal = modal;\n                t.modal.setLarge();\n                t.modal.setSaveButtonText(send);\n\n                t.modal.getRoot().on(ModalEvents.hidden, function() {\n                    t.modal.setBody('');\n                }.bind(this));\n\n                // We catch the modal save event, and use it to submit the form inside the modal.\n                // Triggering a form submission will give JS validation scripts a chance to check for errors.\n                t.modal.getRoot().on(ModalEvents.save, function(e) {\n                    e.preventDefault();\n                    t.modal.getRoot().find('form').submit();\n                });\n                // We also catch the form submit event and use it to submit the form with ajax.\n                t.modal.getRoot().on('submit', 'form', t.submitForm);\n\n                var links = document.querySelectorAll('.messageteacher_link');\n                for (var i = 0; i < links.length; i++) {\n                    if (t.contextid === null) {\n                        t.contextid = links[i].parentElement.parentElement.dataset.contextid;\n                        t.appendurl = links[i].parentElement.parentElement.dataset.appendurl;\n                    }\n                    links[i].addEventListener('click', t.showForm);\n                }\n            });\n        },\n\n        /**\n         * Get the page fragment for the form.\n         *\n         * @param {array} params\n         * @returns {*|Deferred}\n         */\n        getForm: function(params) {\n            return Fragment.loadFragment('block_messageteacher', 'message_form', t.contextid, params);\n        },\n\n        /**\n         * Display the form modal and load the form.\n         *\n         * @param {Event} e\n         */\n        showForm: function(e) {\n            e.preventDefault();\n            t.modal.show();\n            t.modal.setBody(t.getForm(e.currentTarget.dataset));\n        },\n\n        /**\n         * Send the message entered into the form using a core webservice.\n         *\n         * @param {Event} e\n         */\n        submitForm: function(e) {\n            e.preventDefault();\n            var recipientid = t.modal.getRoot().find('[name=recipientid]').val();\n            var message = t.modal.getRoot().find('[name=message]').val();\n            if (t.appendurl) {\n                message += \"\\n\\n\" + t.modal.getRoot().find('[name=referurl]').val();\n            }\n\n            M.util.js_pending('block_messageteacher_send');\n\n            Ajax.call([{\n                methodname: 'core_message_send_instant_messages',\n                args: {\n                    'messages': [\n                        {\n                            'touserid': recipientid,\n                            'text': message\n                        }\n                    ]\n                },\n                done: async function(response) {\n                    t.modal.hide();\n                    if (response.msgid === -1) {\n                        t.responseModal.setBody(response.errormessage);\n                    } else {\n                        const sent = await Str.get_string('messagesent', 'block_messageteacher');\n                        t.responseModal.setBody(sent);\n                    }\n                    t.responseModal.show();\n                    M.util.js_complete('block_messageteacher_send');\n                },\n                fail: function(ex) {\n                    t.modal.hide();\n                    t.responseModal.setBody(ex.message);\n                    t.responseModal.show();\n                    M.util.js_complete('block_messageteacher_send');\n                }\n            }]);\n        }\n    };\n\n    return t;\n});"],"names":["define","Fragment","Ajax","ModalFactory","ModalEvents","Str","t","modal","responseModal","contextid","appendurl","init","async","title","get_string","send","create","type","types","DEFAULT","then","SAVE_CANCEL","setLarge","setSaveButtonText","getRoot","on","hidden","setBody","bind","this","save","e","preventDefault","find","submit","submitForm","links","document","querySelectorAll","i","length","parentElement","dataset","addEventListener","showForm","getForm","params","loadFragment","show","currentTarget","recipientid","val","message","M","util","js_pending","call","methodname","args","done","response","hide","msgid","errormessage","sent","js_complete","fail","ex"],"mappings":"AACAA,mCAAO,CAAC,gBAAiB,YAAa,qBAAsB,oBAAqB,aACzE,SAASC,SAAUC,KAAMC,aAAcC,YAAaC,SAEpDC,EAAI,CACJC,MAAO,KAEPC,cAAe,KAEfC,UAAW,KAEXC,WAAW,EAOXC,KAAMC,uBAEIC,YAAcR,IAAIS,WAAW,aAAc,wBAC3CC,WAAaV,IAAIS,WAAW,OAAQ,wBAE1CX,aAAaa,OAAO,CAChBC,KAAMd,aAAae,MAAMC,QACzBN,MAAOA,QACRO,MAAK,SAASb,OACbD,EAAEE,cAAgBD,SAGtBJ,aAAaa,OAAO,CAChBC,KAAMd,aAAae,MAAMG,YACzBR,MAAOA,QACRO,MAAK,SAASb,OACbD,EAAEC,MAAQA,MACVD,EAAEC,MAAMe,WACRhB,EAAEC,MAAMgB,kBAAkBR,MAE1BT,EAAEC,MAAMiB,UAAUC,GAAGrB,YAAYsB,OAAQ,WACrCpB,EAAEC,MAAMoB,QAAQ,KAClBC,KAAKC,OAIPvB,EAAEC,MAAMiB,UAAUC,GAAGrB,YAAY0B,MAAM,SAASC,GAC5CA,EAAEC,iBACF1B,EAAEC,MAAMiB,UAAUS,KAAK,QAAQC,YAGnC5B,EAAEC,MAAMiB,UAAUC,GAAG,SAAU,OAAQnB,EAAE6B,oBAErCC,MAAQC,SAASC,iBAAiB,wBAC7BC,EAAI,EAAGA,EAAIH,MAAMI,OAAQD,IACV,OAAhBjC,EAAEG,YACFH,EAAEG,UAAY2B,MAAMG,GAAGE,cAAcA,cAAcC,QAAQjC,UAC3DH,EAAEI,UAAY0B,MAAMG,GAAGE,cAAcA,cAAcC,QAAQhC,WAE/D0B,MAAMG,GAAGI,iBAAiB,QAASrC,EAAEsC,cAWjDC,QAAS,SAASC,eACP7C,SAAS8C,aAAa,uBAAwB,eAAgBzC,EAAEG,UAAWqC,SAQtFF,SAAU,SAASb,GACfA,EAAEC,iBACF1B,EAAEC,MAAMyC,OACR1C,EAAEC,MAAMoB,QAAQrB,EAAEuC,QAAQd,EAAEkB,cAAcP,WAQ9CP,WAAY,SAASJ,GACjBA,EAAEC,qBACEkB,YAAc5C,EAAEC,MAAMiB,UAAUS,KAAK,sBAAsBkB,MAC3DC,QAAU9C,EAAEC,MAAMiB,UAAUS,KAAK,kBAAkBkB,MACnD7C,EAAEI,YACF0C,SAAW,OAAS9C,EAAEC,MAAMiB,UAAUS,KAAK,mBAAmBkB,OAGlEE,EAAEC,KAAKC,WAAW,6BAElBrD,KAAKsD,KAAK,CAAC,CACPC,WAAY,qCACZC,KAAM,UACU,CACR,UACgBR,iBACJE,WAIpBO,KAAM/C,eAAegD,aACjBtD,EAAEC,MAAMsD,QACgB,IAApBD,SAASE,MACTxD,EAAEE,cAAcmB,QAAQiC,SAASG,kBAC9B,OACGC,WAAa3D,IAAIS,WAAW,cAAe,wBACjDR,EAAEE,cAAcmB,QAAQqC,MAE5B1D,EAAEE,cAAcwC,OAChBK,EAAEC,KAAKW,YAAY,8BAEvBC,KAAM,SAASC,IACX7D,EAAEC,MAAMsD,OACRvD,EAAEE,cAAcmB,QAAQwC,GAAGf,SAC3B9C,EAAEE,cAAcwC,OAChBK,EAAEC,KAAKW,YAAY,0CAM5B3D"}